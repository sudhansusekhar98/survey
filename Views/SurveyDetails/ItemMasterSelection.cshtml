@model SurveyApp.Models.SurveyDetailsUpdate
@{
	var surveyId = ViewBag.SelectedSurveyId ?? Model?.SurveyID ?? 0;
	var locId = ViewBag.SelectedLocId ?? Model?.LocID ?? 0;
	var itemTypeID = ViewBag.ItemTypeID ?? Model?.ItemTypeID ?? 100;
	var surveyName = ViewBag.SelectedSurveyName ?? "Survey";
	var locName = ViewBag.SelectedLocName ?? "Location";
	
	// Get existing items from database
	var existingItems = Model?.ItemLists ?? new List<SurveyApp.Models.SurveyDetailsUpdatelist>();
	
	// Determine page title from first item or default
	var pageTitle = existingItems.Any() ? (existingItems.First().ItemName ?? "Survey Items") : "Survey Items";
	ViewData["Title"] = pageTitle;
}
<style>
.cam-preview-wrapper{width:120px;height:90px;overflow:hidden;border:1px solid #dee2e6;border-radius:4px;padding:4px;background:#fff;position:relative}
.cam-preview-img{width:100%;height:100%;object-fit:cover}
.cam-preview-wrapper .btn-danger.position-absolute{display:none;top:2px;right:2px;z-index:2}
.cam-preview-wrapper:hover .btn-danger.position-absolute{display:block}
</style>

<form asp-controller="SurveyDetails" asp-action="UpdateItem" method="post" id="cameraDevicesForm">
	@Html.AntiForgeryToken()
	<input type="hidden" asp-for="SurveyID" />
	<input type="hidden" asp-for="LocID" />
	<input type="hidden" asp-for="ItemTypeID" />
	
<div class="container-fluid">
	<div class="row">
		<div class="col-12 mb-6">
			<div class="card shadow mt-4">
<div class="container py-4">
	<div class="card-header bg-purple py-2">
		<div class="row">
			<div class="col-6"><h6 class="text-white fs-4 pt-1">@pageTitle</h6></div>
			<div class="col-6 text-end">
				<a href="@Url.Action("Index", "SurveyDetails", new { surveyId = (Model?.SurveyID ?? 0), locId = (Model?.LocID ?? 0) })" class="btn btn-sm btn-outline-light me-2">
					<i class="bi bi-arrow-left me-1"></i> Back to Survey
				</a>
				<span class="text-white">@surveyName - @locName</span>
			</div>
		</div>
	</div>
      </div>
	<!-- Existing Devices Section -->
	<div class="card mb-4">
		<div class="card-body">
			<h6 class="mb-3">Select the existing types and quantities of items <span class="text-danger">*</span></h6>
				<div class="row g-3 align-items-center">
					@if (existingItems != null && existingItems.Any())
					{
						@for (int i = 0; i < existingItems.Count; i++)
						{
							var item = existingItems[i];
							
							<div class="col-md-12 mb-2">
						<input type="hidden" name="ItemLists[@i].ItemID" value="@item.ItemID" />
						<input type="hidden" name="ItemLists[@i].ItemName" value="@item.ItemName" />
						<input type="hidden" name="ItemLists[@i].ItemCode" value="@item.ItemCode" />
						<input type="hidden" class="item-id-field" data-index="@i" value="@item.ItemID" />
								<div class="d-flex align-items-center cam-device-row">
									<button type="button" class="btn btn-danger btn-sm me-2 cam-qty-minus"><i class="bi bi-dash"></i></button>
									<input type="number" name="ItemLists[@i].ItemQtyExist" class="form-control text-center mx-1 cam-qty-input cam-qty-exist" value="@item.ItemQtyExist" min="0" style="width:60px;" data-index="@i" />
									<button type="button" class="btn btn-success btn-sm ms-2 cam-qty-plus"><i class="bi bi-plus"></i></button>
									<span class="ms-3 fw-semibold">@item.ItemName</span>
									@if (!string.IsNullOrEmpty(item.ItemDesc))
									{
										<span class="ms-2 text-muted small">(@item.ItemDesc)</span>
									}
								</div>
								<div class="cam-extra-section card mt-2 p-3" style="display:@(item.ItemQtyExist > 0 ? "block" : "none");">
									<div class="mb-2">
										<label class="form-label">Images</label>
										<input type="file" class="form-control mb-2 cam-upload-input" multiple accept="image/*" style="display:none;" />
										<button type="button" class="btn btn-primary me-2 cam-take-photo-btn"><i class="bi bi-camera"></i> Take Photo</button>
										<button type="button" class="btn btn-secondary cam-gallery-btn"><i class="bi bi-images"></i> Gallery</button>
										<div class="cam-preview mt-2 d-flex flex-wrap gap-2" data-item-index="@i" data-item-type="exist">
											@if (!string.IsNullOrEmpty(item.ImgPath))
											{
												var imageUrls = item.ImgPath.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
												var publicIds = (!string.IsNullOrEmpty(item.ImgID) ? item.ImgID : "").Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
												
												for (int imgIdx = 0; imgIdx < imageUrls.Length; imgIdx++)
												{
													var imgUrl = imageUrls[imgIdx].Trim();
													var publicId = imgIdx < publicIds.Length ? publicIds[imgIdx].Trim() : "";
													
													<div class="cam-preview-wrapper position-relative d-inline-block" data-public-id="@publicId">
														<img src="@imgUrl" class="cam-preview-img" alt="Survey image" />
														<input type="hidden" name="ItemLists[@i].CloudinaryUrls" value="@imgUrl" />
														<input type="hidden" name="ItemLists[@i].CloudinaryPublicIds" value="@publicId" />
														<button type="button" class="btn btn-sm btn-danger position-absolute cam-delete-existing" data-public-id="@publicId">
															<i class="bi bi-x"></i>
														</button>
													</div>
												}
											}
										</div>
									</div>
									<div>
										<label class="form-label">Remarks</label>
										<textarea name="ItemLists[@i].Remarks" class="form-control" placeholder="Enter remarks...">@item.Remarks</textarea>
									</div>
								</div>
							</div>
						}
					}
					else
					{
						<div class="col-12">
							<p class="text-muted">No items found in the database for this item type.</p>
						</div>
					}
				</div>
		</div>
	</div>

	<!-- New Devices Section -->
	<div class="card mb-4" style="background:#f6fafd;">
		<div class="card-body">
			<h6 class="mb-3">Please select the types and quantities of items to be deployed</h6>
				<div class="row g-3 align-items-center">
					@if (existingItems != null && existingItems.Any())
					{
						@for (int j = 0; j < existingItems.Count; j++)
						{
							var item = existingItems[j];
							
							<div class="col-md-12 mb-2">
								<input type="hidden" class="item-id-field" data-index="@j" value="@item.ItemID" />
								<div class="d-flex align-items-center cam-device-row">
									<button type="button" class="btn btn-danger btn-sm me-2 cam-qty-minus"><i class="bi bi-dash"></i></button>
									<input type="number" name="ItemLists[@j].ItemQtyReq" class="form-control text-center mx-1 cam-qty-input cam-qty-req" value="@item.ItemQtyReq" min="0" style="width:60px;" data-index="@j" />
									<button type="button" class="btn btn-success btn-sm ms-2 cam-qty-plus"><i class="bi bi-plus"></i></button>
									<span class="ms-3 fw-semibold">@item.ItemName</span>
									@if (!string.IsNullOrEmpty(item.ItemDesc))
									{
										<span class="ms-2 text-muted small">(@item.ItemDesc)</span>
									}
								</div>
								<div class="cam-extra-section card mt-2 p-3" style="display:@(item.ItemQtyReq > 0 ? "block" : "none");">
									<div class="mb-2">
										<label class="form-label">Images</label>
										<input type="file" class="form-control mb-2 cam-upload-input" multiple accept="image/*" style="display:none;" />
										<button type="button" class="btn btn-primary me-2 cam-take-photo-btn"><i class="bi bi-camera"></i> Take Photo</button>
										<button type="button" class="btn btn-secondary cam-gallery-btn"><i class="bi bi-images"></i> Gallery</button>
										<div class="cam-preview mt-2 d-flex flex-wrap gap-2" data-item-index="@j" data-item-type="req">
											@if (!string.IsNullOrEmpty(item.ImgPath))
											{
												var imageUrls = item.ImgPath.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
												var publicIds = (!string.IsNullOrEmpty(item.ImgID) ? item.ImgID : "").Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
												
												for (int imgIdx = 0; imgIdx < imageUrls.Length; imgIdx++)
												{
													var imgUrl = imageUrls[imgIdx].Trim();
													var publicId = imgIdx < publicIds.Length ? publicIds[imgIdx].Trim() : "";
													
													<div class="cam-preview-wrapper position-relative d-inline-block" data-public-id="@publicId">
														<img src="@imgUrl" class="cam-preview-img" alt="Survey image" />
														<input type="hidden" name="ItemLists[@j].CloudinaryUrls" value="@imgUrl" />
														<input type="hidden" name="ItemLists[@j].CloudinaryPublicIds" value="@publicId" />
														<button type="button" class="btn btn-sm btn-danger position-absolute cam-delete-existing" data-public-id="@publicId">
															<i class="bi bi-x"></i>
														</button>
													</div>
												}
											}
										</div>
									</div>
									<div>
										<label class="form-label">Remarks</label>
										<textarea name="ItemLists[@j].Remarks" class="form-control" placeholder="Enter remarks...">@item.Remarks</textarea>
									</div>
								</div>
							</div>
						}
					}
					else
					{
						<div class="col-12">
							<p class="text-muted">No items found in the database for this item type.</p>
						</div>
					}
				</div>
				<div class="row mt-3">
					<div class="col-12">
						<label class="form-label">Mounting Details (Overall)</label>
						<textarea class="form-control" name="MountingDetails" placeholder="Location, visibility, obstructions, sunlight, dust, vibration..." rows="3"></textarea>
					</div>
				</div>
				<div class="row mt-4">
					<div class="col-12 text-end">
						<button type="submit" class="btn btn-primary me-2">
							<i class="bi bi-check-circle me-2"></i> Save Survey Data
						</button>
						<a href="@Url.Action("Index", "SurveyDetails", new { surveyId = (Model?.SurveyID ?? 0), locId = (Model?.LocID ?? 0) })" class="btn btn-secondary">
							<i class="bi bi-x-circle me-2"></i> Cancel
						</a>
					</div>
				</div>
		</div>
	</div>
</div>
			</div>
		</div>
    </div>
</form>

<!-- Camera Capture Modal -->
<div id="camDeviceVideoModal" class="modal fade" tabindex="-1">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Capture Image</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body text-center">
				<video id="camDeviceCaptureVideo" autoplay playsinline style="max-width:100%;height:400px;border-radius:8px;"></video>
				<div class="mt-3 d-flex justify-content-center gap-3">
					<button type="button" class="btn btn-gradient-primary px-4 py-2 fw-semibold" id="camDeviceCaptureBtn"><i class="bi bi-camera me-2"></i> Capture</button>
					<button type="button" class="btn btn-outline-danger px-4 py-2 fw-semibold" data-bs-dismiss="modal"><i class="bi bi-x-circle me-2"></i> Cancel</button>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	// Cloudinary integration
	const cloudinaryUploadUrl = '@Url.Action("UploadBase64Image", "Cloudinary")';
	const cloudinaryDeleteUrl = '@Url.Action("DeleteImage", "Cloudinary")';
	// Survey context for folder structure
	const surveyId = @surveyId;
	const locId = @locId;

	document.addEventListener('click', function (e) {
		// Use closest to ensure button click works even if icon is clicked
		const plusBtn = e.target.closest('.cam-qty-plus');
		const minusBtn = e.target.closest('.cam-qty-minus');
		if (!plusBtn && !minusBtn) return;

		const row = e.target.closest('.cam-device-row');
		if (!row) return;
		const input = row.querySelector('.cam-qty-input');
		if (!input) return;

		let current = parseInt(input.value, 10);
		if (isNaN(current) || current < 0) current = 0;

		if (plusBtn) {
			current++;
			input.value = current;
			updateExtraSection(input);
		}
		if (minusBtn) {
			if (current > 0) current--;
			input.value = current;
			updateExtraSection(input);
		}
	});

	document.addEventListener('input', function (e) {
		if (e.target.classList.contains('cam-qty-input')) {
			let val = parseInt(e.target.value, 10);
			if (isNaN(val) || val < 0) val = 0;
			e.target.value = val;
			updateExtraSection(e.target);
		}
	});

	function updateExtraSection(input) {
		if (!input) return;
		const row = input.closest('.col-md-12');
		const qty = parseInt(input.value, 10) || 0;
		const extraSection = row.querySelector('.cam-extra-section');
		if (extraSection) {
			extraSection.style.display = qty > 0 ? '' : 'none';
		}
	}

	// Camera and Gallery logic
	document.addEventListener('click', function (e) {
		// Take Photo
		if (e.target.closest('.cam-take-photo-btn')) {
			const btn = e.target.closest('.cam-take-photo-btn');
			const section = btn.closest('.cam-extra-section');
			const preview = section.querySelector('.cam-preview');
			const modal = new bootstrap.Modal(document.getElementById('camDeviceVideoModal'));
			const video = document.getElementById('camDeviceCaptureVideo');
			const captureBtn = document.getElementById('camDeviceCaptureBtn');
			let stream = null;
			video.srcObject = null;
			
			if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
				navigator.mediaDevices.getUserMedia({ video: true }).then(function (s) {
					stream = s;
					video.srcObject = stream;
					modal.show();
					
						captureBtn.onclick = function () {
							let canvas = document.createElement('canvas');
							canvas.width = video.videoWidth;
							canvas.height = video.videoHeight;
							canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
							
							// Upload to Cloudinary with folder structure
							const itemIndex = preview.dataset.itemIndex;
							const itemId = document.querySelector(`input.item-id-field[data-index="${itemIndex}"]`)?.value || '0';
							uploadToCloudinary(canvas.toDataURL('image/png'), preview, itemId);						modal.hide();
						if (stream) stream.getTracks().forEach(track => track.stop());
					};
					
					document.getElementById('camDeviceVideoModal').addEventListener('hidden.bs.modal', function () {
						if (stream) stream.getTracks().forEach(track => track.stop());
					}, { once: true });
				}).catch(function (err) {
					alert('Camera access denied.');
				});
			} else {
				alert('Camera not supported.');
			}
		}
		
		// Gallery Upload
		if (e.target.closest('.cam-gallery-btn')) {
			const btn = e.target.closest('.cam-gallery-btn');
			const section = btn.closest('.cam-extra-section');
			const uploadInput = section.querySelector('.cam-upload-input');
			const preview = section.querySelector('.cam-preview');
			uploadInput.click();
				uploadInput.onchange = function () {
					const itemIndex = preview.dataset.itemIndex;
					const itemId = document.querySelector(`input.item-id-field[data-index="${itemIndex}"]`)?.value || '0';
					Array.from(uploadInput.files).forEach(file => {
						if (file.type.startsWith('image/')) {
							let reader = new FileReader();
							reader.onload = function (e) {
								// Upload to Cloudinary with folder structure
								uploadToCloudinary(e.target.result, preview, itemId);
						};
						reader.readAsDataURL(file);
					}
				});
				uploadInput.value = ''; // Clear input for next use
			};
		}
	});

	// Function to upload image to Cloudinary
	async function uploadToCloudinary(base64Image, previewContainer, itemId) {
		try {
			// Show loading indicator
			const loadingWrapper = document.createElement('div');
			loadingWrapper.className = 'cam-preview-wrapper position-relative d-inline-block';
			loadingWrapper.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Uploading...</span></div>';
			previewContainer.appendChild(loadingWrapper);

			// Create hierarchical folder structure: survey-{id}/location-{id}/item-{id}
			const folder = `survey-${surveyId}/location-${locId}/item-${itemId}`;

			const response = await fetch(cloudinaryUploadUrl, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					base64Image: base64Image,
					folder: folder
				})
			});

			const result = await response.json();
			
			// Remove loading indicator
			loadingWrapper.remove();

			if (result.success) {
				// Create image preview with Cloudinary URL
				createImagePreview(result.url, result.publicId, previewContainer);
			} else {
				alert('Upload failed: ' + result.message);
			}
		} catch (error) {
			console.error('Error uploading to Cloudinary:', error);
			alert('Error uploading image. Please try again.');
		}
	}

	// Function to create image preview
	function createImagePreview(imageUrl, publicId, previewContainer) {
		const itemIndex = previewContainer.dataset.itemIndex;
		const itemType = previewContainer.dataset.itemType;
		
		let wrapper = document.createElement('div');
		wrapper.className = 'cam-preview-wrapper position-relative d-inline-block';
		wrapper.dataset.publicId = publicId;
		
		let img = document.createElement('img');
		img.src = imageUrl;
		img.className = 'cam-preview-img';
		wrapper.appendChild(img);
		
		// Add hidden input to store URL for form submission with proper naming
		let hiddenInput = document.createElement('input');
		hiddenInput.type = 'hidden';
		hiddenInput.name = `ItemLists[${itemIndex}].CloudinaryUrls`;
		hiddenInput.value = imageUrl;
		wrapper.appendChild(hiddenInput);

		let hiddenPublicId = document.createElement('input');
		hiddenPublicId.type = 'hidden';
		hiddenPublicId.name = `ItemLists[${itemIndex}].CloudinaryPublicIds`;
		hiddenPublicId.value = publicId;
		wrapper.appendChild(hiddenPublicId);
		
		let cancelBtn = document.createElement('button');
		cancelBtn.className = 'btn btn-sm btn-danger position-absolute';
		cancelBtn.innerHTML = '<i class="bi bi-x"></i>';
		cancelBtn.onclick = async function () {
			// Delete from Cloudinary
			try {
				await fetch(cloudinaryDeleteUrl, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ publicId: publicId })
				});
			} catch (error) {
				console.error('Error deleting from Cloudinary:', error);
			}
			wrapper.remove();
		};
		wrapper.appendChild(cancelBtn);
		
		previewContainer.appendChild(wrapper);
	}

	// Handle deletion of existing (pre-loaded) images
	document.addEventListener('click', function(e) {
		if (e.target.closest('.cam-delete-existing')) {
			const btn = e.target.closest('.cam-delete-existing');
			const wrapper = btn.closest('.cam-preview-wrapper');
			const publicId = btn.dataset.publicId;
			
			if (confirm('Are you sure you want to delete this image?')) {
				// Delete from Cloudinary
				if (publicId) {
					fetch(cloudinaryDeleteUrl, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({ publicId: publicId })
					}).then(response => response.json())
					.then(result => {
						if (result.success) {
							wrapper.remove();
						} else {
							console.error('Failed to delete image:', result.message);
							alert('Failed to delete image from cloud storage.');
						}
					})
					.catch(error => {
						console.error('Error deleting from Cloudinary:', error);
						// Still remove from UI even if delete fails
						wrapper.remove();
					});
				} else {
					// No public ID, just remove from UI
					wrapper.remove();
				}
			}
		}
	});
</script>
