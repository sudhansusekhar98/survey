<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Diagnostic Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-bug"></i> PWA Installation Diagnostic</h4>
            </div>
            <div class="card-body">
                <h5>Installation Status:</h5>
                <div id="status" class="mb-4"></div>
                
                <h5>Requirements Check:</h5>
                <ul id="requirements" class="list-group mb-4"></ul>
                
                <h5>Browser Information:</h5>
                <div id="browser-info" class="alert alert-info"></div>
                
                <h5>Manifest Check:</h5>
                <div id="manifest-check" class="mb-4"></div>
                
                <h5>Service Worker Status:</h5>
                <div id="sw-status" class="mb-4"></div>
                
                <button id="test-install" class="btn btn-success">
                    <i class="bi bi-download"></i> Test Install Prompt
                </button>
                <button id="refresh" class="btn btn-secondary">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Check
                </button>
            </div>
        </div>
    </div>

    <script>
        let deferredPrompt;
        
        function addRequirement(text, passed) {
            const list = document.getElementById('requirements');
            const item = document.createElement('li');
            item.className = `list-group-item ${passed ? 'list-group-item-success' : 'list-group-item-danger'}`;
            item.innerHTML = `<i class="bi bi-${passed ? 'check-circle' : 'x-circle'}"></i> ${text}`;
            list.appendChild(item);
        }
        
        function checkPWA() {
            // Clear previous results
            document.getElementById('requirements').innerHTML = '';
            
            // Check HTTPS
            const isHTTPS = window.location.protocol === 'https:' || window.location.hostname === 'localhost';
            addRequirement(`HTTPS: ${window.location.protocol}`, isHTTPS);
            
            // Check Service Worker support
            const hasSW = 'serviceWorker' in navigator;
            addRequirement('Service Worker API supported', hasSW);
            
            // Check if already installed
            const isInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                               window.navigator.standalone === true;
            addRequirement(`Not already installed (standalone: ${isInstalled})`, !isInstalled);
            
            // Check beforeinstallprompt support
            let hasPrompt = !!deferredPrompt;
            addRequirement('beforeinstallprompt event received', hasPrompt);
            
            // Browser info
            const ua = navigator.userAgent;
            let browser = 'Unknown';
            if (ua.indexOf('Edg') > -1) browser = 'Edge (✅ Supports PWA)';
            else if (ua.indexOf('Chrome') > -1) browser = 'Chrome (✅ Supports PWA)';
            else if (ua.indexOf('Firefox') > -1) browser = 'Firefox (⚠️ Limited PWA support)';
            else if (ua.indexOf('Safari') > -1) browser = 'Safari (✅ Supports PWA on iOS 16.4+)';
            
            document.getElementById('browser-info').innerHTML = `
                <strong>Browser:</strong> ${browser}<br>
                <strong>User Agent:</strong> ${ua}<br>
                <strong>Platform:</strong> ${navigator.platform}
            `;
            
            // Status
            const status = document.getElementById('status');
            if (isInstalled) {
                status.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> App is already installed!</div>';
            } else if (hasPrompt) {
                status.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> App is ready to install!</div>';
            } else {
                status.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> Waiting for install prompt... (may require page interaction)</div>';
            }
            
            // Check manifest
            fetch('/manifest.json')
                .then(response => response.json())
                .then(manifest => {
                    document.getElementById('manifest-check').innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> Manifest loaded successfully<br>
                            <strong>App Name:</strong> ${manifest.name}<br>
                            <strong>Start URL:</strong> ${manifest.start_url}<br>
                            <strong>Icons:</strong> ${manifest.icons.length} icons defined
                        </div>
                    `;
                })
                .catch(err => {
                    document.getElementById('manifest-check').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle"></i> Failed to load manifest: ${err.message}
                        </div>
                    `;
                });
            
            // Check service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration()
                    .then(registration => {
                        if (registration) {
                            document.getElementById('sw-status').innerHTML = `
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle"></i> Service Worker registered<br>
                                    <strong>Scope:</strong> ${registration.scope}<br>
                                    <strong>State:</strong> ${registration.active ? registration.active.state : 'N/A'}
                                </div>
                            `;
                        } else {
                            document.getElementById('sw-status').innerHTML = `
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle"></i> No Service Worker registered yet
                                </div>
                            `;
                        }
                    });
            } else {
                document.getElementById('sw-status').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i> Service Worker not supported
                    </div>
                `;
            }
        }
        
        // Listen for beforeinstallprompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('beforeinstallprompt fired!');
            checkPWA();
        });
        
        // Test install button
        document.getElementById('test-install').addEventListener('click', async () => {
            if (!deferredPrompt) {
                alert('Install prompt not available. Check requirements above.');
                return;
            }
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            alert(`Install ${outcome === 'accepted' ? 'accepted' : 'dismissed'}`);
            deferredPrompt = null;
            checkPWA();
        });
        
        // Refresh button
        document.getElementById('refresh').addEventListener('click', () => {
            checkPWA();
        });
        
        // Initial check
        setTimeout(checkPWA, 1000);
    </script>
</body>
</html>
