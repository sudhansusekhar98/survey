@model SurveyApp.Models.DetailedSurveyReportModel
@{
    ViewData["Title"] = "Detailed Survey Report";
}

<div class="container-fluid">
    <div class="card shadow-lg border-0">
        <div class="card-header py-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 0.5rem 0.5rem 0 0;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="text-white mb-0 fw-bold">
                        <i class="bi bi-clipboard-data me-2"></i>@Model.ReportTitle
                    </h5>
                </div>
                <div>
                    <a asp-action="SummaryReport" class="btn btn-outline-light btn-sm me-2">
                        <i class="bi bi-arrow-left me-1"></i>Back
                    </a>
                    <button onclick="window.print()" class="btn btn-light btn-sm me-2">
                        <i class="bi bi-printer me-1"></i>Print
                    </button>
                    <a asp-action="ExportDetailedReport" 
                       asp-route-surveyId="@Model.Survey.SurveyId"
                       class="btn btn-success btn-sm">
                        <i class="bi bi-file-earmark-excel me-1"></i>Export to Excel
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            <!-- Report Info -->
            <div class="alert alert-light border-0 shadow-sm mb-4 no-print" style="background: linear-gradient(to right, #f8f9fa, #e9ecef);">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1">
                            <i class="bi bi-person-circle text-primary me-2"></i>
                            <strong>Generated By:</strong> <span class="text-muted">@Model.GeneratedBy</span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1">
                            <i class="bi bi-clock-history text-primary me-2"></i>
                            <strong>Generated On:</strong> <span class="text-muted">@Model.GeneratedDate.ToString("dd-MMM-yyyy HH:mm")</span>
                        </p>
                    </div>
                </div>
            </div>

            @if (Model.Survey == null)
            {
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>Survey not found.
                </div>
            }
            else
            {
                var survey = Model.Survey;
                var statusClass = survey.SurveyStatus switch
                {
                    "Completed" => "success",
                    "In Progress" => "warning",
                    "Pending" => "secondary",
                    "On Hold" => "danger",
                    _ => "dark"
                };
                var isOverdue = survey.DueDate.HasValue && survey.DueDate.Value < DateTime.Now && survey.SurveyStatus != "Completed";

                <!-- Survey Overview -->
                <div class="card mb-4 shadow-sm border-0">
                    <div class="card-header py-2 mb-2" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);">
                        <h6 class="mb-0 text-white" style="font-size:1rem;"><i class="bi bi-info-circle-fill me-2"></i>Survey Overview</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <td class="text-muted fw-semibold" width="40%">Survey ID:</td>
                                        <td>@survey.SurveyId</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted fw-semibold">Survey Name:</td>
                                        <td><strong>@survey.SurveyName</strong></td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted fw-semibold">Status:</td>
                                        <td><span class="badge bg-@statusClass">@survey.SurveyStatus</span></td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted fw-semibold">Region:</td>
                                        <td>@survey.RegionName</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted fw-semibold">Implementation Type:</td>
                                        <td>@survey.ImplementationType</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <td class="text-muted fw-semibold" width="40%">Survey Date:</td>
                                        <td>@(survey.SurveyDate?.ToString("dd-MMM-yyyy") ?? "-")</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted fw-semibold">Due Date:</td>
                                        <td>
                                            @if (survey.DueDate.HasValue)
                                            {
                                                <span class="@(isOverdue ? "text-danger fw-bold" : "")">
                                                    @survey.DueDate.Value.ToString("dd-MMM-yyyy")
                                                    @if (isOverdue)
                                                    {
                                                        <i class="bi bi-exclamation-triangle ms-1"></i>
                                                        <span class="badge bg-danger ms-2">Overdue</span>
                                                    }
                                                </span>
                                            }
                                            else
                                            {
                                                <span>-</span>
                                            }
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted fw-semibold">Created Date:</td>
                                        <td>@(survey.SurveyDate?.ToString("dd-MMM-yyyy") ?? "-")</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted fw-semibold">Created By:</td>
                                        <td>@survey.CreatedBy</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(survey.ScopeOfWork))
                        {
                            <hr />
                            <div>
                                <h6 class="text-muted fw-semibold mb-2">Scope of Work:</h6>
                                <p class="mb-0">@survey.ScopeOfWork</p>
                            </div>
                        }
                    </div>
                </div>

                <!-- Survey Locations -->
                <div class="card mb-4 shadow-sm border-0">
                    <div class="card-header py-2 mb-2 d-flex justify-content-between align-items-center" style="background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);">
                        <h6 class="mb-0 text-white" style="font-size:1rem;"><i class="bi bi-geo-alt-fill me-2"></i>Survey Locations</h6>
                        <span class="badge bg-white text-dark">@Model.Locations.Count locations</span>
                    </div>
                    <div class="card-body">
                        @if (Model.Locations.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Location ID</th>
                                            <th>Location Name</th>
                                            <th>Location Type</th>
                                            <th>Latitude</th>
                                            <th>Longitude</th>
                                            <th>Created On</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var location in Model.Locations)
                                        {
                                            <tr>
                                                <td>@location.LocID</td>
                                                <td>@location.LocName</td>
                                                <td>@(location.LocationType ?? "-")</td>
                                                <td>@(location.LocLat?.ToString("0.000000") ?? "-")</td>
                                                <td>@(location.LocLog?.ToString("0.000000") ?? "-")</td>
                                                <td>@(location.CreateOn?.ToString("dd-MMM-yyyy") ?? "-")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted text-center mb-0">No locations assigned to this survey.</p>
                        }
                    </div>
                </div>

                <!-- Survey Assignments -->
                <div class="card mb-4 shadow-sm border-0">
                    <div class="card-header py-2 mb-2 d-flex justify-content-between align-items-center" style="background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);">
                        <h6 class="mb-0 text-white" style="font-size:1rem;"><i class="bi bi-person-check-fill me-2"></i>Survey Assignments</h6>
                        <span class="badge bg-white text-dark">@Model.Assignments.Count assigned</span>
                    </div>
                    <div class="card-body">
                        @if (Model.Assignments.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Transaction ID</th>
                                            <th>Survey ID</th>
                                            <th>Employee ID</th>
                                            <th>Employee Name</th>
                                            <th>Due Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var assignment in Model.Assignments)
                                        {
                                            <tr>
                                                <td>@assignment.TransID</td>
                                                <td>@assignment.SurveyID</td>
                                                <td>@assignment.EmpID</td>
                                                <td>@(assignment.EmpName ?? "-")</td>
                                                <td>@assignment.DueDate.ToString("dd-MMM-yyyy")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted text-center mb-0">No employees assigned to this survey.</p>
                        }
                    </div>
                </div>

                <!-- Survey Submissions -->
                <div class="card mb-4 shadow-sm border-0">
                    <div class="card-header py-2 mb-2 d-flex justify-content-between align-items-center" style="background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);">
                        <h6 class="mb-0 text-white" style="font-size:1rem;"><i class="bi bi-file-earmark-text-fill me-2"></i>Survey Submissions</h6>
                        <span class="badge bg-white text-dark">@Model.Submissions.Count submissions</span>
                    </div>
                    <div class="card-body">
                        @if (Model.Submissions.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Submission ID</th>
                                            <th>Survey Name</th>
                                            <th>Submitted By</th>
                                            <th>Submission Date</th>
                                            <th>Status</th>
                                            <th>Reviewed By</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var submission in Model.Submissions)
                                        {
                                            var subStatusClass = submission.SubmissionStatus switch
                                            {
                                                "Approved" => "success",
                                                "Submitted" => "info",
                                                "Rejected" => "danger",
                                                "Pending Review" => "warning",
                                                _ => "secondary"
                                            };
                                            <tr>
                                                <td>@submission.SubmissionId</td>
                                                <td>@submission.SurveyName</td>
                                                <td>@submission.SubmittedByName</td>
                                                <td>@(submission.SubmissionDate?.ToString("dd-MMM-yyyy HH:mm") ?? "-")</td>
                                                <td><span class="badge bg-@subStatusClass">@submission.SubmissionStatus</span></td>
                                                <td>@(submission.ReviewedByName ?? "-")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted text-center mb-0">No submissions recorded for this survey.</p>
                        }
                    </div>
                </div>

                <!-- Survey Details / Devices -->
                <div class="card mb-4 shadow-sm border-0">
                    <div class="card-header py-2 mb-2 d-flex justify-content-between align-items-center" style="background: linear-gradient(90deg, #fa709a 0%, #fee140 100%);">
                        <h6 class="mb-0 text-white" style="font-size:1rem;"><i class="bi bi-hdd-rack-fill me-2"></i>Survey Details / Devices</h6>
                        <div>
                            <span class="badge bg-white text-dark me-2">@Model.SurveyDetails.Sum(d => d.ItemLists.Count) items</span>
                            <span class="badge bg-white text-dark">@Model.SurveyDetails.Count types</span>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (Model.SurveyDetails.Any())
                        {
                            <div class="accordion" id="devicesAccordion">
                                @for (int i = 0; i < Model.SurveyDetails.Count; i++)
                                {
                                    var detail = Model.SurveyDetails[i];
                                    var accordionId = $"device{i}";
                                    <div class="accordion-item border mb-2 rounded">
                                        <h2 class="accordion-header" id="heading@(i)">
                                            <button class="accordion-button @(i > 0 ? "collapsed" : "")" type="button" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#@accordionId" 
                                                    aria-expanded="@(i == 0 ? "true" : "false")" 
                                                    aria-controls="@accordionId"
                                                    style="background: linear-gradient(to right, #f8f9fa, #ffffff);">
                                                <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                                    <div>
                                                        <i class="bi bi-geo-alt-fill text-primary me-2"></i>
                                                        <strong>@detail.LocName</strong> - <span class="text-muted">@detail.TypeName</span>
                                                    </div>
                                                    <div>
                                                        <span class="badge bg-primary">@detail.ItemLists.Count items</span>
                                                    </div>
                                                </div>
                                            </button>
                                        </h2>
                                        <div id="@accordionId" class="accordion-collapse collapse @(i == 0 ? "show" : "")" 
                                             aria-labelledby="heading@(i)" 
                                             data-bs-parent="#devicesAccordion">
                                            <div class="accordion-body">
                                                @if (!string.IsNullOrEmpty(detail.TypeDesc))
                                                {
                                                    <div class="alert alert-info border-0 mb-3">
                                                        <i class="bi bi-info-circle me-2"></i>@detail.TypeDesc
                                                    </div>
                                                }
                                                @if (detail.ItemLists.Any())
                                                {
                                                    <div class="table-responsive">
                                                        <table class="table table-hover table-striped">
                                                            <thead style="background: linear-gradient(to right, #667eea, #764ba2); color: white;">
                                                                <tr>
                                                                    <th>ID</th>
                                                                    <th>Item Name</th>
                                                                    <th>Description</th>
                                                                    <th class="text-center">Qty Existing</th>
                                                                    <th class="text-center">Qty Required</th>
                                                                    <th>Remarks</th>
                                                                    <th class="text-center">Image</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                @foreach (var item in detail.ItemLists)
                                                                {
                                                                    <tr>
                                                                        <td><span class="badge bg-secondary">@item.ItemID</span></td>
                                                                        <td><strong class="text-primary">@item.ItemName</strong></td>
                                                                        <td><small>@(item.ItemDesc ?? "-")</small></td>
                                                                        <td class="text-center">
                                                                            <span class="badge rounded-pill bg-info">@item.ItemQtyExist</span>
                                                                        </td>
                                                                        <td class="text-center">
                                                                            <span class="badge rounded-pill bg-success">@item.ItemQtyReq</span>
                                                                        </td>
                                                                        <td><small class="text-muted">@(item.Remarks ?? "-")</small></td>
                                                                        <td class="text-center">
                                                                            @if (!string.IsNullOrEmpty(item.ImgPath))
                                                                            {
                                                                                <a href="@item.ImgPath" target="_blank" class="btn btn-sm btn-outline-primary">
                                                                                    <i class="bi bi-image"></i> View
                                                                                </a>
                                                                            }
                                                                            else
                                                                            {
                                                                                <span class="text-muted">-</span>
                                                                            }
                                                                        </td>
                                                                    </tr>
                                                                }
                                                            </tbody>
                                                            <tfoot class="table-light">
                                                                <tr>
                                                                    <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                                                    <td class="text-center">
                                                                        <strong class="text-info">@detail.ItemLists.Sum(i => i.ItemQtyExist)</strong>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <strong class="text-success">@detail.ItemLists.Sum(i => i.ItemQtyReq)</strong>
                                                                    </td>
                                                                    <td colspan="2"></td>
                                                                </tr>
                                                            </tfoot>
                                                        </table>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <p class="text-muted text-center mb-0">No items recorded for this type.</p>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                                <p class="text-muted mt-3 mb-0">No survey details/devices recorded for this survey.</p>
                            </div>
                        }
                    </div>
                </div>

                <!-- Progress Summary -->
                <div class="card shadow-sm border-0">
                    <div class="card-header py-2 mb-2" style="background: linear-gradient(90deg, #30cfd0 0%, #330867 100%);">
                        <h6 class="mb-0 text-white" style="font-size:1rem;"><i class="bi bi-bar-chart-fill me-2"></i>Progress Summary</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="card border-primary">
                                    <div class="card-body text-center">
                                        <h4 class="text-primary mb-1">@Model.Locations.Count</h4>
                                        <p class="mb-0 text-muted">Total Locations</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card border-success">
                                    <div class="card-body text-center">
                                        <h4 class="text-success mb-1">@Model.Assignments.Count</h4>
                                        <p class="mb-0 text-muted">Total Assignments</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card border-info">
                                    <div class="card-body text-center">
                                        <h4 class="text-info mb-1">@Model.Submissions.Count</h4>
                                        <p class="mb-0 text-muted">Total Submissions</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .accordion-button:not(.collapsed) {
        background-color: #f8f9fa;
        box-shadow: none;
    }
    
    .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(0,0,0,.125);
    }
    
    .card {
        border-radius: 0.5rem;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .table thead th {
        font-weight: 600;
        font-size: 0.875rem;
        letter-spacing: 0.5px;
    }
    
    .badge {
        font-weight: 500;
    }
    
    @@media print {
        .no-print {
            display: none !important;
        }
        .card {
            border: 1px solid #ddd !important;
            box-shadow: none !important;
            page-break-inside: avoid;
        }
        .accordion-collapse {
            display: block !important;
        }
        .accordion-button::after {
            display: none;
        }
    }
</style>
